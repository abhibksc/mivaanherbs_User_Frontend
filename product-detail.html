<!-- File: product-detail.html -->
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>Product Details - Mivaan Herbs</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="icon" href="img/favicon.ico" />
    <link rel="stylesheet" href="css/bootstrap.min.css" />
    <link rel="stylesheet" href="css/style.css" />
  </head>
  <body>
    <!-- Header -->
    <div class="container-fluid bg-white sticky-top">
      <div class="container">
        <nav class="navbar navbar-expand-lg bg-white navbar-light py-2 py-lg-0">
          <a href="index.html" class="navbar-brand">
            <img class="img-fluid" src="img/logo.png" alt="Logo" />
          </a>
          <div class="collapse navbar-collapse">
            <div class="navbar-nav ms-auto">
              <a href="index.html" class="nav-item nav-link">Home</a>
              <a href="product-listing.html" class="nav-item nav-link"
                >Products</a
              >
              <a href="store.html" class="nav-item nav-link">Store</a>
              <a href="contact.html" class="nav-item nav-link">Contact</a>
            </div>
          </div>
        </nav>
      </div>
    </div>

    <!-- Product Detail Content -->
    <div class="container py-5">
      <div class="row">
        <div class="col-md-6">
          <img
            id="product-img"
            class="img-fluid rounded shadow"
            alt="Product Image"
          />
        </div>
        <div class="col-md-6">
          <h2 id="product-name" class="mb-3"></h2>
          <h4 id="product-price" class="text-primary mb-3"></h4>
          <p id="product-desc"></p>
          <button
            class="btn btn-sm btn-dark mt-2 buy-btn"
            data-id="2"
            data-name="Green Aloevera Tulsi"
            data-price="19.00"
            data-img="img/store-product-2.jpg"
          >
            Buy
          </button>
        </div>
      </div>
    </div>

    <!-- Footer -->
    <footer class="bg-dark text-white py-4 mt-5">
      <div class="container text-center">
        &copy; 2025 Mivaan Herbs Pvt Ltd. Designed by
        <a href="https://itgenixs.com/" class="text-primary">IT GENIXS</a>.
      </div>
    </footer>

    <div
      class="modal fade"
      id="buyModal"
      tabindex="-1"
      aria-labelledby="buyModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Confirm Purchase</h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <div class="modal-body" id="modalProductInfo">
            Are you sure you want to buy this product?
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              Cancel
            </button>
            <button type="button" class="btn btn-success" id="confirmBuyBtn">
              Confirm Buy
            </button>
          </div>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

    <script>
      // Extract product ID from URL
      const params = new URLSearchParams(window.location.search);
      const id = params.get("id");

      // Dummy product data (you can fetch from API in future)
      const products = [
        {
          id: "1",
          name: "Nature Close Aloevera",
          price: "19.00",
          img: "img/store-product-1.jpg",
          desc: "This is a detailed description for Nature Close Aloevera.",
        },
        {
          id: "2",
          name: "Green Aloevera Tulsi",
          price: "19.00",
          img: "img/store-product-2.jpg",
          desc: "This is a detailed description for Green Aloevera Tulsi.",
        },
      ];

      const product = products.find((p) => p.id === id);
      if (product) {
        document.getElementById("product-name").innerText = product.name;
        document.getElementById("product-price").innerText =
          "$" + product.price;
        document.getElementById("product-desc").innerText = product.desc;
        document.getElementById("product-img").src = product.img;

        document
          .querySelector(".add-to-cart-btn")
          .addEventListener("click", () => {
            const cartItem = {
              id: product.id,
              name: product.name,
              price: product.price,
              img: product.img,
              quantity: 1,
            };
            let cart = JSON.parse(localStorage.getItem("cart")) || [];
            const index = cart.findIndex((item) => item.id === cartItem.id);
            if (index > -1) {
              cart[index].quantity += 1;
            } else {
              cart.push(cartItem);
            }
            localStorage.setItem("cart", JSON.stringify(cart));
            alert(`${product.name} added to cart!`);
          });
      } else {
        document.querySelector(
          ".container"
        ).innerHTML = `<h3 class="text-center">Product not found</h3>`;
      }
    </script>

    <script>
      document.addEventListener("DOMContentLoaded", function () {
        let selectedProduct = null;

        document.querySelectorAll(".buy-btn").forEach((button) => {
          button.addEventListener("click", function () {

              const token = localStorage.getItem("token");

    if (!token) {
      // Redirect to signup if not logged in
      window.location.href = "signup.html";
      return;
    }


    
            selectedProduct = {
              id: this.dataset.id,
              name: this.dataset.name,
              price: this.dataset.price,
              img: this.dataset.img,
            };

            document.getElementById(
              "modalProductInfo"
            ).innerText = `Are you sure you want to buy "${selectedProduct.name}" for $${selectedProduct.price}?`;

            const modal = new bootstrap.Modal(
              document.getElementById("buyModal")
            );
            modal.show();
          });
        });

        document
          .getElementById("confirmBuyBtn")
          .addEventListener("click", function () {
            if (selectedProduct) {
              purchaseItem(selectedProduct);
              const modal = bootstrap.Modal.getInstance(
                document.getElementById("buyModal")
              );
              modal.hide();
            }
          });

        function purchaseItem(product) {
          // üî• Replace with your real API base URL
          const apiUrl = "https://mivaanherbs.onrender.com/api/user/activate";
          const token = localStorage.getItem("token"); // Or any key you're using to store login state
          const userName = localStorage.getItem("userName"); // Or any key you're using to store login state

          //  username, packageAmount

          fetch(apiUrl, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              Authorization: `Bearer ${token}`, // Replace with actual token
            },
            body: JSON.stringify({
              username: userName,
              packageAmount: product.price,
            }),
          })
            .then((response) => {
              if (!response.ok) {
                throw new Error("Network response was not ok");
              }
              return response.json();
            })
            .then((data) => {
              alert(
                `‚úÖ Activated: ${product.name} (${data.message || "Success"})`
              );
              console.log("Server Response:", data);
            })
            .catch((error) => {
              console.error("Activation failed:", error);
              alert("‚ùå Purchase failed. Please try again.");
            });
        }
      });
    </script>
  </body>
</html>
